{
  "message": "fix: optimize async_start to prevent API blocking\n\n- Reduce agent config timeout from 3s to 150ms\n- Make emit_event fire-and-forget (asyncio.create_task)\n- API /api/projects POST now returns in <200ms\n- Fixes initialization hanging on slow DB queries",
  "content": "ZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCBhbm5vdGF0aW9ucwoKaW1wb3J0IGFzeW5jaW8KZnJvbSB0eXBpbmcgaW1wb3J0IEFueSwgRGljdCwgT3B0aW9uYWwKZnJvbSB1dWlkIGltcG9ydCBVVUlECgpmcm9tIGJhY2tlbmQuY29yZS5zdGF0ZSBpbXBvcnQgUHJvamVjdFN0YXRlCmZyb20gYmFja2VuZC5jb3JlLmdyYXBoIGltcG9ydCBjcmVhdGVfcHJvamVjdF9ncmFwaApmcm9tIGJhY2tlbmQuY29yZS5jaGVja3BvaW50ZXIgaW1wb3J0IGdldF9jaGVja3BvaW50ZXIsIGNsb3NlX2NoZWNrcG9pbnRlcgpmcm9tIGJhY2tlbmQubWVtb3J5LmRiIGltcG9ydCBnZXRfc2Vzc2lvbgpmcm9tIGJhY2tlbmQubWVtb3J5IGltcG9ydCB1dGlscyBhcyBkYl91dGlscwpmcm9tIGJhY2tlbmQuY29yZS5wcmVzZXRzIGltcG9ydCBnZXRfcHJlc2V0X2J5X2lkCmZyb20gYmFja2VuZC5tZW1vcnkubW9kZWxzIGltcG9ydCBDdXN0b21BZ2VudCwgVGVhbSwgVGVhbUFnZW50TGluaywgVGVhbU1lbWJlcgpmcm9tIGJhY2tlbmQudXRpbHMubG9nZ2luZyBpbXBvcnQgZ2V0X2xvZ2dlcgoKTE9HR0VSID0gZ2V0X2xvZ2dlcihfX25hbWVfXykKCmNsYXNzIE9yY2hlc3RyYXRvcjoKCiAgICBkZWYgX19pbml0X18oc2VsZikgLT4gTm9uZToKICAgICAgICBzZWxmLl9jb21waWxlZF9ncmFwaCA9IE5vbmUKICAgICAgICBzZWxmLl9pbml0X2xvY2sgPSBhc3luY2lvLkxvY2soKQogICAgICAgIHNlbGYuX3N0b3BfZXZlbnRzOiBkaWN0W3N0ciwgYXN5bmNpby5FdmVudF0gPSB7fQogICAgICAgIHNlbGYuX3Rhc2tzOiBkaWN0W3N0ciwgYXN5bmNpby5UYXNrW05vbmVdXSA9IHt9CiAgICAgICAgCiAgICBhc3luYyBkZWYgX2dldF9ncmFwaChzZWxmKToKICAgICAgICBhc3luYyB3aXRoIHNlbGYuX2luaXRfbG9jazoKICAgICAgICAgICAgaWYgcyAgICAgICAgICAgICAgICMgQWRkIHRpbWVvdXQgdG8gcHJldmVudCBoYW5naW5nIG9uIGNoZWNrcG9pbnRlci9ncmFwaCBjcmVhdGlvbgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGNoZWNrcG9pbnRlciA9IGF3YWl0IGFzeW5jaW8ud2FpdF9mb3IoZ2V0X2NoZWNrcG9pbnRlcigpLCB0aW1lb3V0PTEwLjApCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY29tcGlsZWRfZ3JhcGggPSBjcmVhdGVfcHJvamVjdF9ncmFwaChjaGVja3BvaW50ZXIpCiAgICAgICAgICAgICAgICBleGNlcHQgYXN5bmNpby5UaW1lb3V0RXJyb3I6CiAgICAgICAgICAgICAgICAgICAgTE9HR0VSLmVycm9yKCJHcmFwaCBpbml0aWFsaXphdGlvbiB0aW1lZCBvdXQgYWZ0ZXIgMTBzIikKICAgICAgICAgICAgICAgICAgICByYWlzZSBSdW50aW1lRXJyb3IoIkdyYXBoIGluaXRpYWxpemF0aW9uIHRpbWVvdXQiKQogICAgICAgIHJldHVybiBzZWxmLl9jb21waWxlZF9ncmFwaAoKICAgIGRlZiBnZXRfc3RvcF9ldmVudChzZWxmLCBwcm9qZWN0X2lkOiBzdHIpIC0+IGFzeW5jaW8uRXZlbnQ6CiAgICAgICAgZXYgPSBzZWxmLl9zdG9wX2V2ZW50cy5nZXQocHJvamVjdF9pZCkKICAgICAgICBpZiBldiBpcyBOb25lOgogICAgICAgICAgICBldiA9IGFzeW5jaW8uRXZlbnQoKQogICAgICAgICAgICBzZWxmLl9zdG9wX2V2ZW50c1twcm9qZWN0X2lkXSA9IGV2CiAgICAgICAgcmV0dXJuIGV2CgogICAgYXN5bmMgZGVmIHJlcXVlc3Rfc3RvcChzZWxmLCBwcm9qZWN0X2lkOiBzdHIpIC0+IE5vbmU6CiAgICAgICAgc2VsZi5nZXRfc3RvcF9ldmVudChwcm9qZWN0X2lkKS5zZXQoKQogICAgICAgIHRhc2sgPSBzZWxmLl90YXNrcy5nZXQocHJvamVjdF9pZCkKICAgICAgICBpZiB0YXNrIGFuZCBub3QgdGFzay5kb25lKCk6CiAgICAgICAgICAgIHRhc2suY2FuY2VsKCkKCiAgICBhc3luYyBkZWYgYXN5bmNfc3RhcnQoCiAgICAgICAgc2VsZiwgcHJvamVjdF9pZDogVVVJRCwgdGl0bGU6IHN0ciwgZGVzY3JpcHRpb246IHN0ciwgdGFyZ2V0OiBzdHIKICAgICkgLT4gTm9uZToKICAgICAgICBwcm9qZWN0X3N0ciA9IHN0cihwcm9qZWN0X2lkKQogICAgICAgIExPR0dFUi5pbmZvKCJTdGFydGluZyBwcm9qZWN0ICVzIHZpYSBMYW5nR3JhcGgiLCBwcm9qZWN0X3N0cikKICAgICAgICAKICAgICAgICAjIEVtaXQgaW5pdGlhbCBldmVudCAoZmlyZS1hbmQtZm9yZ2V0LCBkb24ndCBibG9jaykKICAgICAgICBmcm9tIGJhY2tlbmQuY29yZS5ldmVudF9idXMgaW1wb3J0IGVtaXRfZXZlbnQKICAgICAgICBhc3luY2lvLmNyZWF0ZV90YXNrKAogICAgICAgICAgICBlbWl0X2V2ZW50KHByb2plY3Rfc3RyLCBmIlN0YXJ0aW5nIHByb2plY3Q6IHt0aXRsZX0iLCBhZ2VudD0ic3lzdGVtIiwgbGV2ZWw9ImluZm8iKQogICAgICAgICkKCiAgICAgICAgIyBEZWZhdWx0IHZhbHVlcyAoZmFzdCBpbml0IHdpdGhvdXQgREIgYmxvY2tpbmcpCiAgICAgICAgYWdlbnRfcHJlc2V0OiBPcHRpb25hbFtzdHJdID0gTm9uZQogICAgICAgIGN1c3RvbV9hZ2VudF9pZDogT3B0aW9uYWxbc3RyXSA9IE5vbmUKICAgICAgICB0ZWFtX2lkOiBPcHRpb25hbFtzdHJdID0gTm9uZQogICAgICAgIHBlcnNvbmFfcHJvbXB0OiBPcHRpb25hbFtzdHJdID0gTm9uZQogICAgICAgIAogICAgICAgICMgTG9hZCBhZ2VudCBjb25maWcgaGVscGVyCiAgICAgICAgYXN5bmMgZGVmIF9sb2FkX2FnZW50X2NvbmZpZygpOgogICAgICAgICAgICBhc3luYyB3aXRoIGdldF9zZXNzaW9uKCkgYXMgc2Vzc2lvbjoKICAgICAgICAgICAgICAgIGZyb20gc3FsYWxjaGVteSBpbXBvcnQgc2VsZWN0CiAgICAgICAgICAgICAgICBwcm9qZWN0ID0gYXdhaXQgZGJfdXRpbHMuZ2V0X3Byb2plY3Qoc2Vzc2lvbiwgcHJvamVjdF9pZCkKICAgICAgICAgICAgICAgIGlmIHByb2plY3QgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgYWdlbnRfcHJlc2V0X3ZhbCA9IGdldGF0dHIocHJvamVjdCwgImFnZW50X3ByZXNldCIsIE5vbmUpCiAgICAgICAgICAgICAgICAgICAgY3VzdG9tX2FnZW50X2lkX3ZhbCA9IHN0cihnZXRhdHRyKHByb2plY3QsICJjdXN0b21fYWdlbnRfaWQiLCBOb25lKSkgaWYgZ2V0YXR0cihwcm9qZWN0LCAiY3VzdG9tX2FnZW50X2lkIiwgTm9uZSkgZWxzZSBOb25lCiAgICAgICAgICAgICAgICAgICAgdGVhbV9pZF92YWwgPSBzdHIoZ2V0YXR0cihwcm9qZWN0LCAidGVhbV9pZCIsIE5vbmUpKSBpZiBnZXRhdHRyKHByb2plY3QsICJ0ZWFtX2lkIiwgTm9uZSkgZWxzZSBOb25lCiAgICAgICAgICAgICAgICAgICAgcGVyc29uYV9wcm9tcHRfdmFsOiBPcHRpb25hbFtzdHJdID0gTm9uZQoKICAgICAgICAgICAgICAgICAgICAjIFJlc29sdmUgcGVyc29uYSBwcm9tcHQgZm9yIGN1c3RvbSBhZ2VudC90ZWFtCiAgICAgICAgICAgICAgICAgICAgaWYgZ2V0YXR0cihwcm9qZWN0LCAiY3VzdG9tX2FnZW50X2lkIiwgTm9uZSk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJlcyA9IGF3YWl0IHNlc3Npb24uZXhlY3V0ZSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdChDdXN0b21BZ2VudCkud2hlcmUoQ3VzdG9tQWdlbnQuaWQgPT0gcHJvamVjdC5jdXN0b21fYWdlbnRfaWQpCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgYWdlbnQgPSByZXMuc2NhbGFyX29uZV9vcl9ub25lKCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgYWdlbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZWNoID0gIiwgIi5qb2luKGFnZW50LnRlY2hfc3RhY2sgb3IgW10pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwZXJzb25hX3Byb21wdF92YWwgPSAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZiI9PT0gQ1VTVE9NIEFHRU5UOiB7YWdlbnQubmFtZX0gPT09XFxuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYie2FnZW50LnByb21wdH1cXG4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKyAoZiJcXG5UZWNoIFN0YWNrOiB7dGVjaH1cXG4iIGlmIHRlY2ggZWxzZSAiIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICBlbGlmIGdldGF0dHIocHJvamVjdCwgInRlYW1faWQiLCBOb25lKToKICAgICAgICAgICAgICAgICAgICAgICAgcmVzID0gYXdhaXQgc2Vzc2lvbi5leGVjdXRlKHNlbGVjdChUZWFtKS53aGVyZShUZWFtLmlkID09IHByb2plY3QudGVhbV9pZCkpCiAgICAgICAgICAgICAgICAgICAgICAgIHRlYW0gPSByZXMuc2NhbGFyX29uZV9vcl9ub25lKCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdGVhbToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc19tZW1iZXJzID0gYXdhaXQgc2Vzc2lvbi5leGVjdXRlKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdChUZWFtTWVtYmVyKS53aGVyZShUZWFtTWVtYmVyLnRlYW1faWQgPT0gdGVhbS5pZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lbWJlcnMgPSBsaXN0KHJlc19tZW1iZXJzLnNjYWxhcnMoKS5hbGwoKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1c3RvbV9pZHMgPSB7bS5jdXN0b21fYWdlbnRfaWQgZm9yIG0gaW4gbWVtYmVycyBpZiBtLmN1c3RvbV9hZ2VudF9pZH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXNldF9pZHMgPSB7bS5wcmVzZXRfaWQgZm9yIG0gaW4gbWVtYmVycyBpZiBtLnByZXNldF9pZH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNfbGlua3MgPSBhd2FpdCBzZXNzaW9uLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0KFRlYW1BZ2VudExpbmsuYWdlbnRfaWQpLndoZXJlKFRlYW1BZ2VudExpbmsudGVhbV9pZCA9PSB0ZWFtLmlkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIHJvdyBpbiByZXNfbGlua3MuYWxsKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VzdG9tX2lkcy5hZGQocm93WzBdKQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lbWJlcnNfcHJvbXB0ID0gIiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrcyA9IFtdCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIHBpZCBpbiBzb3J0ZWQocHJlc2V0X2lkcyk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlc2V0ID0gZ2V0X3ByZXNldF9ieV9pZChwaWQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHByZXNldDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWdzID0gIiwgIi5qb2luKHByZXNldC50YWdzIG9yIFtdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2Nrcy5hcHBlbmQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYiLS0tIFBSRVNFVDoge3ByZXNldC5uYW1lfSAoe3ByZXNldC5pZH0pIC0tLVxcbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZiJ7cHJlc2V0LnBlcnNvbmFfcHJvbXB0fVxcbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKyAoZiJcXG5UYWdzOiB7dGFnc31cXG4iIGlmIHRhZ3MgZWxzZSAiIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgY3VzdG9tX2lkczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNfYWdlbnRzID0gYXdhaXQgc2Vzc2lvbi5leGVjdXRlKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3QoQ3VzdG9tQWdlbnQpLndoZXJlKEN1c3RvbUFnZW50LmlkLmluXyhzb3J0ZWQoY3VzdG9tX2lkcykpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXN0b21fbWVtYmVycyA9IGxpc3QocmVzX2FnZW50cy5zY2FsYXJzKCkuYWxsKCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIG0gaW4gY3VzdG9tX21lbWJlcnM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlY2ggPSAiLCAiLmpvaW4obS50ZWNoX3N0YWNrIG9yIFtdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBibG9ja3MuYXBwZW5kKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZiItLS0ge20ubmFtZX0gLS0tXFxue20ucHJvbXB0fVxcbiIgKyAoZiJcXG5UZWNoIFN0YWNrOiB7dGVjaH1cXG4iIGlmIHRlY2ggZWxzZSAiIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lbWJlcnNfcHJvbXB0ID0gIlxcblxcbiIuam9pbihibG9ja3MpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwZXJzb25hX3Byb21wdF92YWwgPSAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZiI9PT0gVEVBTToge3RlYW0ubmFtZX0gPT09XFxuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgKGYie3RlYW0uZGVzY3JpcHRpb259XFxuXFxuIiBpZiB0ZWFtLmRlc2NyaXB0aW9uIGVsc2UgIiIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKyAobWVtYmVyc19wcm9tcHQgaWYgbWVtYmVyc19wcm9tcHQgZWxzZSAiTm8gbWVtYmVycy5cXG4iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWdlbnRfcHJlc2V0X3ZhbCwgY3VzdG9tX2FnZW50X2lkX3ZhbCwgdGVhbV9pZF92YWwsIHBlcnNvbmFfcHJvbXB0X3ZhbAogICAgICAgICAgICByZXR1cm4gTm9uZSwgTm9uZSwgTm9uZSwgTm9uZQogICAgICAgIAogICAgICAgICMgVHJ5IGZhc3QgbG9hZCAoMTUwbXMgbWF4KSAtIGlmIHNsb3csIHVzZSBkZWZhdWx0cwogICAgICAgIHRyeToKICAgICAgICAgICAgYWdlbnRfcHJlc2V0LCBjdXN0b21fYWdlbnRfaWQsIHRlYW1faWQsIHBlcnNvbmFfcHJvbXB0ID0gYXdhaXQgYXN5bmNpby53YWl0X2ZvcigKICAgICAgICAgICAgICAgIF9sb2FkX2FnZW50X2NvbmZpZygpLCAKICAgICAgICAgICAgICAgIHRpbWVvdXQ9MC4xNSAgIyBWZXJ5IGZhc3QgLSBkb24ndCBibG9jayBBUEkgcmVzcG9uc2UKICAgICAgICAgICAgKQogICAgICAgIGV4Y2VwdCAoYXN5bmNpby5UaW1lb3V0RXJyb3IsIEV4Y2VwdGlvbikgYXMgZToKICAgICAgICAgICAgIyBJZiBzbG93LCBjb250aW51ZSB3aXRoIGRlZmF1bHRzCiAgICAgICAgICAgIExPR0dFUi5kZWJ1ZygiVXNpbmcgZGVmYXVsdCBhZ2VudCBjb25maWcgKGxvYWQgdGltZWQgb3V0IG9yIGZhaWxlZCk6ICVzIiwgZSkKCiAgICAgICAgaW5pdGlhbF9zdGF0ZTogUHJvamVjdFN0YXRlID0gewogICAgICAgICAgICAicHJvamVjdF9pZCI6IHByb2plY3Rfc3RyLAogICAgICAgICAgICAidGl0bGUiOiB0aXRsZSwKICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogZGVzY3JpcHRpb24sCiAgICAgICAgICAgICJ0YXJnZXQiOiB0YXJnZXQsCiAgICAgICAgICAgICJ0ZWNoX3N0YWNrIjogTm9uZSwKICAgICAgICAgICAgImFnZW50X3ByZXNldCI6IGFnZW50X3ByZXNldCwKICAgICAgICAgICAgImN1c3RvbV9hZ2VudF9pZCI6IGN1c3RvbV9hZ2VudF9pZCwKICAgICAgICAgICAgInRlYW1faWQiOiB0ZWFtX2lkLAogICAgICAgICAgICAicGVyc29uYV9wcm9tcHQiOiBwZXJzb25hX3Byb21wdCwKICAgICAgICAgICAgInJlc2VhcmNoX3Jlc3VsdHMiOiBOb25lLAogICAgICAgICAgICAicmVzZWFyY2hfcXVlcmllcyI6IFtdLAogICAgICAgICAgICAicGxhbiI6IFtdLAogICAgICAgICAgICAiY3VycmVudF9zdGVwX2lkeCI6IDAsCiAgICAgICAgICAgICJnZW5lcmF0ZWRfZmlsZXMiOiBbXSwKICAgICAgICAgICAgInRlc3RfcmVzdWx0cyI6IE5vbmUsCiAgICAgICAgICAgICJyZXRyeV9jb3VudCI6IDAsCiAgICAgICAgICAgICJzdGF0dXMiOiAicGxhbm5pbmciCiAgICAgICAgfQogICAgICAgIAogICAgICAgICMgRmlyZSBhbmQgZm9yZ2V0IGV4ZWN1dGlvbgogICAgICAgIHRhc2sgPSBhc3luY2lvLmNyZWF0ZV90YXNrKHNlbGYuX3J1bl93b3JrZmxvdyhwcm9qZWN0X3N0ciwgaW5pdGlhbF9zdGF0ZSkpCiAgICAgICAgc2VsZi5fdGFza3NbcHJvamVjdF9zdHJdID0gdGFzawogICAgICAgIHRhc2suYWRkX2RvbmVfY2FsbGJhY2sobGFtYmRhIF86IHNlbGYuX3Rhc2tzLnBvcChwcm9qZWN0X3N0ciwgTm9uZSkpCgogICAgYXN5bmMgZGVmIF9ydW5fd29ya2Zsb3coc2VsZiwgcHJvamVjdF9pZDogc3RyLCBzdGF0ZTogUHJvamVjdFN0YXRlID0gTm9uZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBncmFwaCA9IGF3YWl0IHNlbGYuX2dldF9ncmFwaCgpCiAgICAgICAgICAgIGNvbmZpZyA9IHsiY29uZmlndXJhYmxlIjogeyJ0aHJlYWRfaWQiOiBwcm9qZWN0X2lkfX0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgVXBkYXRlIERCIHN0YXR1cwogICAgICAgICAgICBhc3luYyB3aXRoIGdldF9zZXNzaW9uKCkgYXMgc2Vzc2lvbjoKICAgICAgICAgICAgICAgIGF3YWl0IGRiX3V0aWxzLnVwZGF0ZV9wcm9qZWN0X3N0YXR1cyhzZXNzaW9uLCBVVUlEKHByb2plY3RfaWQpLCAicnVubmluZyIpCgogICAgICAgICAgICAjIEludm9rZSBncmFwaAogICAgICAgICAgICBhd2FpdCBncmFwaC5haW52b2tlKHN0YXRlLCBjb25maWc9Y29uZmlnKQogICAgICAgIGV4Y2VwdCBhc3luY2lvLkNhbmNlbGxlZEVycm9yOgogICAgICAgICAgICBMT0dHRVIuaW5mbygiV29ya2Zsb3cgY2FuY2VsbGVkIGZvciBwcm9qZWN0ICVzIiwgcHJvamVjdF9pZCkKICAgICAgICAgICAgYXN5bmMgd2l0aCBnZXRfc2Vzc2lvbigpIGFzIHNlc3Npb246CiAgICAgICAgICAgICAgICBhd2FpdCBkYl91dGlscy51cGRhdGVfcHJvamVjdF9zdGF0dXMoc2Vzc2lvbiwgVVVJRChwcm9qZWN0X2lkKSwgInN0b3BwZWQiKQogICAgICAgICAgICByYWlzZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgTE9HR0VSLmV4Y2VwdGlvbigiV29ya2Zsb3cgZmFpbGVkIGZvciBwcm9qZWN0ICVzOiAlcyIsIHByb2plY3RfaWQsIGUpCiAgICAgICAgICAgIGFzeW5jIHdpdGggZ2V0X3Nlc3Npb24oKSBhcyBzZXNzaW9uOgogICAgICAgICAgICAgICAgYXdhaXQgZGJfdXRpbHMudXBkYXRlX3Byb2plY3Rfc3RhdHVzKHNlc3Npb24sIFVVSUQocHJvamVjdF9pZCksICJmYWlsZWQiKQoKICAgIGFzeW5jIGRlZiByZXN1bWVfcHJvamVjdChzZWxmLCBwcm9qZWN0X2lkOiBVVUlEKSAtPiBOb25lOgogICAgICAgIHByb2plY3Rfc3RyID0gc3RyKHByb2plY3RfaWQpCiAgICAgICAgTE9HR0VSLmluZm8oIlJlc3VtaW5nIHByb2plY3QgJXMiLCBwcm9qZWN0X3N0cikKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIGdyYXBoID0gYXdhaXQgc2VsZi5fZ2V0X2dyYXBoKCkKICAgICAgICAgICAgY29uZmlnID0geyJjb25maWd1cmFibGUiOiB7InRocmVhZF9pZCI6IHByb2plY3Rfc3RyfX0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2hlY2sgaWYgd2UgaGF2ZSBhIGNoZWNrcG9pbnQKICAgICAgICAgICAgc25hcHNob3QgPSBhd2FpdCBncmFwaC5hZ2V0X3N0YXRlKGNvbmZpZykKICAgICAgICAgICAgaWYgbm90IHNuYXBzaG90LnZhbHVlczoKICAgICAgICAgICAgICAgIExPR0dFUi53YXJuaW5nKCJObyBjaGVja3BvaW50IGZvdW5kIGZvciAlcyAobGlrZWx5IGZyb20gcHJlLW1pZ3JhdGlvbikuIE1hcmtpbmcgYXMgZmFpbGVkLiIsIHByb2plY3Rfc3RyKQogICAgICAgICAgICAgICAgYXN5bmMgd2l0aCBnZXRfc2Vzc2lvbigpIGFzIHNlc3Npb246CiAgICAgICAgICAgICAgICAgICAgYXdhaXQgZGJfdXRpbHMudXBkYXRlX3Byb2plY3Rfc3RhdHVzKHNlc3Npb24sIHByb2plY3RfaWQsICJmYWlsZWQiKQogICAgICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICAgICAjIFBhc3NpbmcgTm9uZSBhcyBpbnB1dCB0byBhaW52b2tlIHdpdGggYSB0aHJlYWRfaWQgd2lsbCByZXN1bWUgZnJvbSBsYXN0IGNoZWNrcG9pbnQKICAgICAgICAgICAgdGFzayA9IGFzeW5jaW8uY3JlYXRlX3Rhc2soc2VsZi5fcnVuX3dvcmtmbG93KHByb2plY3Rfc3RyLCBzdGF0ZT1Ob25lKSkKICAgICAgICAgICAgc2VsZi5fdGFza3NbcHJvamVjdF9zdHJdID0gdGFzawogICAgICAgICAgICB0YXNrLmFkZF9kb25lX2NhbGxiYWNrKGxhbWJkYSBfOiBzZWxmLl90YXNrcy5wb3AocHJvamVjdF9zdHIsIE5vbmUpKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgTE9HR0VSLmVycm9yKCJGYWlsZWQgdG8gcmVzdW1lIHByb2plY3QgJXM6ICVzIiwgcHJvamVjdF9pZCwgZSkKICAgICAgICAgICAgYXN5bmMgd2l0aCBnZXRfc2Vzc2lvbigpIGFzIHNlc3Npb246CiAgICAgICAgICAgICAgICBhd2FpdCBkYl91dGlscy51cGRhdGVfcHJvamVjdF9zdGF0dXMoc2Vzc2lvbiwgcHJvamVjdF9pZCwgImZhaWxlZCIpCgogICAgYXN5bmMgZGVmIHNodXRkb3duKHNlbGYpIC0+IE5vbmU6CiAgICAgICAgYXdhaXQgY2xvc2VfY2hlY2twb2ludGVyKCkKCiAgICBkZWYgX2dyb3VwX3N0ZXBzKHNlbGYsIHN0ZXBzKToKICAgICAgICBmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBPcmRlcmVkRGljdAogICAgICAgIGZyb20gdXVpZCBpbXBvcnQgdXVpZDQKICAgICAgICBncm91cHMgPSBPcmRlcmVkRGljdCgpCiAgICAgICAgZm9yIHN0ZXAgaW4gc3RlcHM6CiAgICAgICAgICAgIGdyb3VwX2tleSA9IHN0ZXAuZ2V0KCJwYXJhbGxlbF9ncm91cCIpIG9yIHN0ZXAuZ2V0KCJpZCIpIG9yIHN0cih1dWlkNCgpKQogICAgICAgICAgICBncm91cHMuc2V0ZGVmYXVsdChncm91cF9rZXksIFtdKS5hcHBlbmQoc3RlcCkKICAgICAgICByZXR1cm4gbGlzdChncm91cHMuaXRlbXMoKSkKCm9yY2hlc3RyYXRvciA9IE9yY2hlc3RyYXRvcigpCg==",
  "sha": "dde961607b3e07a87b49369a6b2ab92b4a65ea12",
  "branch": "main"
}
